##
## NGINX Reverse Proxy für SealAI – stabil & websocket-/SSE-fähig
##

# Diese Direktiven stehen im http{}-Kontext (conf.d wird dort inkludiert):

# Upgrade → Connection-Header sauber abbilden
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Subprotocol/Extensions nur weiterreichen, wenn vorhanden
map $http_sec_websocket_protocol  $ws_subproto   { default $http_sec_websocket_protocol;  '' ''; }
map $http_sec_websocket_extensions $ws_extensions { default $http_sec_websocket_extensions; '' ''; }

# Warnung "could not build optimal proxy_headers_hash" beseitigen
proxy_headers_hash_max_size 1024;
proxy_headers_hash_bucket_size 128;

# 1) HTTP → HTTPS
server {
    listen      80;
    listen      [::]:80;
    server_name sealai.net www.sealai.net auth.sealai.net;
    return 301 https://$host$request_uri;
}

# 2) Haupt-vHost (https://sealai.net)
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name sealai.net www.sealai.net;

    ssl_certificate      /etc/letsencrypt/live/sealai.net/fullchain.pem;
    ssl_certificate_key  /etc/letsencrypt/live/sealai.net/privkey.pem;

    # Sicherheitsheader
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy no-referrer;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Upload-Limits
    client_max_body_size 25m;

    # --- NextAuth MUSS zum Frontend (größere Header-Buffer!) ---
    location ^~ /api/auth/ {
        include /etc/nginx/snippets/sealai_proxy_headers.conf;

        proxy_buffer_size          128k;
        proxy_buffers              8 128k;
        proxy_busy_buffers_size    256k;

        proxy_read_timeout  120s;
        proxy_send_timeout  120s;

        proxy_pass http://frontend:3000/api/auth/;
    }

    # --- WebSocket zum Backend ---
    location ^~ /api/v1/ai/ws {
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Sec-WebSocket-Protocol   $ws_subproto;
        proxy_set_header Sec-WebSocket-Extensions $ws_extensions;

        include /etc/nginx/snippets/sealai_proxy_headers.conf;

        proxy_buffering off;
        proxy_read_timeout  86400s;
        proxy_send_timeout  86400s;

        proxy_pass http://backend:8000/api/v1/ai/ws;
    }

    # --- SSE zum Backend: /api/v1/langgraph/*
    location ^~ /api/v1/langgraph/ {
        include /etc/nginx/snippets/sealai_proxy_headers.conf;

        # WICHTIG für sofortiges Streaming:
        proxy_buffering off;
        proxy_request_buffering off;
        chunked_transfer_encoding on;
        proxy_read_timeout  86400s;
        proxy_send_timeout  86400s;

        add_header X-Accel-Buffering no;
        add_header Cache-Control "no-cache, no-transform";

        proxy_pass http://backend:8000/api/v1/langgraph/;
    }

    # --- REST API (Default) zum Backend ---
    location ^~ /api/v1/ {
        include /etc/nginx/snippets/sealai_proxy_headers.conf;
        proxy_read_timeout  120s;
        proxy_send_timeout  120s;
        proxy_pass http://backend:8000/api/v1/;
    }

    # Health passthrough
    location = /health {
        proxy_pass http://backend:8000/health;
    }

    # --- Frontend (Next.js) Default ---
    location / {
        include /etc/nginx/snippets/sealai_proxy_headers.conf;
        proxy_read_timeout  120s;
        proxy_send_timeout  120s;
        proxy_pass http://frontend:3000;
    }
}

# 3) Auth-Subdomain (https://auth.sealai.net) → Keycloak
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name auth.sealai.net;

    ssl_certificate      /etc/letsencrypt/live/auth.sealai.net/fullchain.pem;
    ssl_certificate_key  /etc/letsencrypt/live/auth.sealai.net/privkey.pem;

    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy no-referrer;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        include /etc/nginx/snippets/sealai_proxy_headers.conf;
        proxy_set_header X-Forwarded-Proto https;
        proxy_read_timeout 300s;
        proxy_redirect off;
        proxy_pass https://keycloak:8443;
        proxy_ssl_server_name on;
        proxy_ssl_name keycloak;
        proxy_ssl_verify off;
    }
}
